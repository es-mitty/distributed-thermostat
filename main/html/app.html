<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thermostat</title>
</head>

<body>
</body>
<script>
    const body = document.body;
    const data_endpoint = "http://thermostat.local/data";

    json_store = {
        "system_name": "Unamed System",
        "zone_len":0,
        "zones": []
    };

    function changeItem(key, index, value) {
        json_store.zones[index][key] = value;
        console.log(json_store);
        refresh_server();
    }

    function gen_input_elem(element, key, index, label) {
        return `<label for="${key}">${label}</label><input type="text" id="${key}" value="${element[key]}" onchange="changeItem(${key}, ${index}, this.value)"><br>`;
    }

    function refresh_ui() {
        body.innerHTML = "";
        document.title = json_store.system_name;
        heading = document.createElement("h1");
        heading.innerHTML = json_store.system_name;
        body.appendChild(heading);
        json_store.zones.forEach((element, index, array) => {
            elem = document.createElement("section");
            elem.innerHTML += gen_input_elem(element, "name", index, "Name");
            elem.innerHTML += gen_input_elem(element, "target_temp", index, "Desired Temp");
            elem.innerHTML += `Measured Temp: ${element.measured_temp}`;
            body.appendChild(elem);
        });
    }
    refresh_ui();

    function escapeSpecialChars(inputString) {
    const escapeMap = {
        "'": "\\'",
        '"': '\\"',
        '\\': '\\\\',
        '\n': '\\n',
        '\r': '\\r',
        '\t': '\\t',
        '\b': '\\b',
        '\f': '\\f',
    };
    return inputString.replace(/(['"\\\n\r\t\b\f])/g, (match) => escapeMap[match]);
}

    async function refresh_server() {
        resp = JSON.stringify(json_store);
        const response = await fetch(data_endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: `${resp}`
        });
    }

    async function getData() {
        response = await fetch(data_endpoint);
        json = await response.text();
        if (json) {
            json_store = JSON.parse(json);
            refresh_ui();
        }
    }
    getData();
    setInterval(getData, 5000);
</script>

</html>